group: "k8s tests"
steps:
  - name: k8sbuild
    wanda: ci/docker/k8s.build.wanda.yaml
    depends_on:
      - oss-ci-base_build

  - label: ":kubernetes: operator"
    tags:
      - python
      - docker
    instance_type: medium
    commands:
      # Build ray container image
      - bazel run //ci/ray_ci:build_in_docker -- docker --python-version 3.8 --platform cpu
        --canonical-tag kuberay-test
      - bazel run //ci/ray_ci:test_in_docker -- //python/ray/tests/... serverless
        --build-name k8sbuild
        --only-tags kuberay_operator
        --test-env=RAY_IMAGE=docker.io/rayproject/ray:kuberay-test
        --test-env=PULL_POLICY=Never
        --test-env=KUBECONFIG=/root/.kube/config
        --test-env=RAY_TEST_SETUP_KUBERAY=1
    depends_on:
      - k8sbuild
      - manylinux
      - forge
      - raycpubase
